#!/usr/bin/env bash
set -euo pipefail

# Block large files (> 2MB)
max=2000000
while IFS= read -r -d '' f; do
  size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f")
  if [ "$size" -gt "$max" ]; then
    echo "❌ Blocked: $f is $(numfmt --to=iec $size), exceeds 2MB"
    exit 1
  fi
done < <(git diff --cached --name-only -z | xargs -0 -I{} bash -lc 'if [ -f "{}" ]; then printf "%s\0" "{}"; fi')

# Block disallowed paths
for p in dist/ .next/ .nuxt/ .svelte-kit/ .output/ .vercel/ coverage/ playwright-report/ cypress/videos/ cypress/screenshots/; do
  if git diff --cached --name-only | grep -qE "^$p"; then
    echo "❌ Blocked: committing build/test artifacts in $p"
    exit 1
  fi
done

exit 0
