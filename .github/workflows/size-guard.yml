name: size-guard
on:
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  block-large-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Fail on files > 2 MB
        shell: bash
        run: |
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          echo "Checking files changed between $base and $head"
          changed=$(git diff --name-only "$base"..."$head" || true)
          fail=0
          for f in $changed; do
            [ -f "$f" ] || continue
            bytes=$(wc -c < "$f")
            if [ "$bytes" -gt $((2*1024*1024)) ]; then
              echo "::error file=$f::File exceeds 2MB ($bytes bytes)"
              fail=1
            fi
          done
          [ "$fail" -eq 0 ] || { echo "❌ Large files detected"; exit 1; }
          echo "✅ All changed files < 2MB"
